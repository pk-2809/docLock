@if (isOpen) {
<div class="fixed inset-0 z-50 flex flex-col justify-end w-full h-full">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" (click)="onClose()"></div>

    <!-- Bottom Sheet -->
    <div class="relative w-full bg-white rounded-t-3xl p-8 animate-slide-up shadow-2xl z-10">
        <!-- Handle for mobile -->
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>

        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-8 h-8 text-indigo-600">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                </svg>
            </div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Verify it's you</h3>
            <p class="text-slate-500 text-sm">
                Enter the 6-digit code sent to<br>
                <span class="text-slate-900 font-medium">{{ maskedLabel }}</span>
            </p>
        </div>

        @if (!isLoading) {
        <div class="flex gap-2 justify-center mb-8 relative">
            <!-- Invisible input for autocomplete -->
            <input type="text" autocomplete="one-time-code" class="absolute inset-0 opacity-0 -z-10"
                (input)="onInput(0, $event)">

            @for (digit of otp; track i; let i = $index) {
            <input #otpInput type="password" inputmode="numeric" maxlength="1" [value]="digit"
                (input)="onInput(i, $event)" (keydown)="onKeyDown(i, $event)" [class.border-red-500]="isError"
                [class.text-red-500]="isError"
                class="w-10 h-12 sm:w-12 sm:h-14 bg-slate-100 border-2 border-transparent rounded-xl text-center text-slate-900 text-xl font-bold focus:outline-none focus:border-indigo-500 focus:bg-white transition-all caret-indigo-500">
            }
        </div>

        <!-- Timer / Resend Button -->
        <div class="text-center mb-4 min-h-[24px]">
            @if (isResending) {
            <div class="inline-flex justify-center">
                <div class="w-5 h-5 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
            </div>
            } @else if (canResend && resendAttempts < maxResendAttempts) { <button (click)="onResend()"
                class="text-indigo-600 font-bold text-sm hover:underline">
                Resend Code
                </button>
                } @else if (resendAttempts >= maxResendAttempts) {
                <p class="text-red-500 text-sm font-medium">Max resend attempts reached</p>
                } @else {
                <p class="text-slate-500 text-sm font-medium">
                    Resend code in <span class="text-indigo-600">{{ resendTimer() }}s</span>
                </p>
                }
        </div>
        } @else {
        <!-- Verifying State -->
        <div class="flex flex-col items-center justify-center py-8 animate-fade-in">
            <div class="relative w-16 h-16 mb-4">
                <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin">
                </div>
            </div>
            <p class="text-lg font-bold text-slate-900 mb-1">Verifying...</p>
            <p class="text-slate-500 text-sm">Please wait while we check your code</p>
        </div>
        }
    </div>
</div>
}